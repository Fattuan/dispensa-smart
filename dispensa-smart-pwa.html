<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dispensa Smart</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Gestisci il tuo inventario di casa e la lista della spesa">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Dispensa Smart">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .app-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            color: white;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: white;
            border-bottom: 2px solid #e5e7eb;
            position: sticky;
            top: 70px;
            z-index: 99;
        }

        .tab {
            flex: 1;
            padding: 12px 8px;
            background: none;
            border: none;
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-icon {
            font-size: 20px;
        }

        /* Content */
        .content {
            padding: 16px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Stats Badge */
        .stats-badge {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 16px;
        }

        .stats-number {
            font-size: 32px;
            font-weight: 800;
            color: #b45309;
        }

        .stats-label {
            font-size: 13px;
            color: #92400e;
            margin-top: 4px;
        }

        /* Input Form */
        .input-form {
            background: #f9fafb;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
        }

        .input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            background: white;
        }

        .input:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        select.input {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%23374151' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        /* Autocomplete */
        .autocomplete {
            position: relative;
        }

        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .suggestions.show {
            display: block;
        }

        .suggestion-item {
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:active {
            background: #f3f4f6;
        }

        .suggestion-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .suggestion-text {
            flex: 1;
            min-width: 0;
        }

        .suggestion-name {
            font-size: 15px;
            font-weight: 600;
            color: #111827;
        }

        .suggestion-category {
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
        }

        /* Notes */
        .notes-area {
            display: none;
            margin-bottom: 12px;
        }

        .notes-area.show {
            display: block;
        }

        textarea.input {
            resize: vertical;
            min-height: 60px;
            font-size: 14px;
        }

        /* Add Button */
        .btn-add {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            transition: all 0.2s;
        }

        .btn-add:active {
            transform: scale(0.98);
            box-shadow: 0 1px 4px rgba(102, 126, 234, 0.3);
        }

        /* Items List */
        .items-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .item {
            background: #f9fafb;
            border-radius: 12px;
            padding: 12px;
            border: 2px solid #e5e7eb;
        }

        .item.checked {
            opacity: 0.6;
        }

        .item-header {
            display: flex;
            align-items: start;
            gap: 10px;
            margin-bottom: 8px;
        }

        .item-icon {
            font-size: 28px;
            flex-shrink: 0;
        }

        .item-info {
            flex: 1;
            min-width: 0;
        }

        .item-name {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }

        .item.checked .item-name {
            text-decoration: line-through;
        }

        .item-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }

        .category-badge {
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }

        .item-quantity {
            font-size: 13px;
            color: #6b7280;
            font-weight: 500;
        }

        .item-notes {
            font-size: 13px;
            color: #4b5563;
            margin-top: 8px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            font-style: italic;
        }

        /* Item Actions */
        .item-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
            gap: 6px;
            margin-top: 10px;
        }

        .btn-action {
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .btn-action:active {
            transform: scale(0.95);
        }

        .btn-check { background: #fbbf24; color: white; }
        .btn-note { background: #3b82f6; color: white; }
        .btn-move { background: #10b981; color: white; }
        .btn-delete { background: #ef4444; color: white; }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 16px;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 6px;
        }

        .empty-subtext {
            font-size: 14px;
            color: #9ca3af;
        }

        /* Statistics */
        .stats-container {
            padding-bottom: 20px;
        }

        .stats-title {
            font-size: 20px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 20px;
            text-align: center;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            color: white;
        }

        .stats-card-number {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .stats-card-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .chart-container {
            background: #f9fafb;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .chart-title {
            font-size: 15px;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 16px;
            text-align: center;
        }

        #pieChart {
            display: block;
            margin: 0 auto;
        }

        .category-list {
            background: #f9fafb;
            padding: 16px;
            border-radius: 12px;
        }

        .category-list-title {
            font-size: 15px;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 12px;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .category-item:last-child {
            border-bottom: none;
        }

        .category-item-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .category-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .category-item-name {
            font-size: 14px;
            font-weight: 600;
            color: #111827;
        }

        .category-item-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .category-item-count {
            font-size: 14px;
            font-weight: 600;
            color: #4b5563;
        }

        .category-item-percent {
            font-size: 13px;
            color: #9ca3af;
            min-width: 40px;
            text-align: right;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            padding: 20px;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 400px;
            width: 100%;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 16px;
        }

        .modal-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 16px;
        }

        .modal-btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-btn-cancel {
            background: #e5e7eb;
            color: #4b5563;
        }

        .modal-btn-save {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        /* Install Button */
        .install-btn {
            position: fixed;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 15px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            cursor: pointer;
            z-index: 9998;
            display: none;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <h1>üõí Dispensa Smart</h1>
            <p>La tua cucina organizzata</p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('inventory')">
                <span class="tab-icon">üè†</span>
                <span>In Casa</span>
            </button>
            <button class="tab" onclick="switchTab('shopping')">
                <span class="tab-icon">üìù</span>
                <span>Spesa</span>
            </button>
            <button class="tab" onclick="switchTab('stats')">
                <span class="tab-icon">üìä</span>
                <span>Stats</span>
            </button>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Inventory Section -->
            <div id="inventory" class="section active">
                <div class="stats-badge">
                    <div class="stats-number" id="inventoryCount">0</div>
                    <div class="stats-label">Articoli in casa</div>
                </div>

                <div class="input-form">
                    <div class="form-group autocomplete">
                        <label class="form-label">Alimento</label>
                        <input
                            type="text"
                            id="inventorySearch"
                            class="input"
                            placeholder="Cerca o scrivi..."
                            oninput="handleSearch('inventory')"
                        />
                        <div id="inventorySuggestions" class="suggestions"></div>
                    </div>

                    <div class="form-group">
                        <div class="input-row">
                            <div>
                                <label class="form-label">Quantit√†</label>
                                <input type="text" id="inventoryQty" class="input" placeholder="1">
                            </div>
                            <div>
                                <label class="form-label">Unit√†</label>
                                <select id="inventoryUnit" class="input">
                                    <option value="pz">pz</option>
                                    <option value="kg">kg</option>
                                    <option value="g">g</option>
                                    <option value="L">L</option>
                                    <option value="ml">ml</option>
                                    <option value="conf">conf</option>
                                    <option value="scat">scat</option>
                                    <option value="vas">vas</option>
                                    <option value="bott">bott</option>
                                    <option value="pacco">pacco</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="inventoryNotes" class="notes-area">
                        <div class="form-group">
                            <label class="form-label">Note (opzionale)</label>
                            <textarea id="inventoryNotesInput" class="input" placeholder="Es: biologico, scadenza 15/02..."></textarea>
                        </div>
                    </div>

                    <button class="btn-add" onclick="addItem('inventory')">+ Aggiungi</button>
                </div>

                <div id="inventoryList" class="items-list"></div>
            </div>

            <!-- Shopping Section -->
            <div id="shopping" class="section">
                <div class="stats-badge">
                    <div class="stats-number" id="shoppingCount">0</div>
                    <div class="stats-label">Da comprare</div>
                </div>

                <div class="input-form">
                    <div class="form-group autocomplete">
                        <label class="form-label">Alimento</label>
                        <input
                            type="text"
                            id="shoppingSearch"
                            class="input"
                            placeholder="Cerca o scrivi..."
                            oninput="handleSearch('shopping')"
                        />
                        <div id="shoppingSuggestions" class="suggestions"></div>
                    </div>

                    <div class="form-group">
                        <div class="input-row">
                            <div>
                                <label class="form-label">Quantit√†</label>
                                <input type="text" id="shoppingQty" class="input" placeholder="1">
                            </div>
                            <div>
                                <label class="form-label">Unit√†</label>
                                <select id="shoppingUnit" class="input">
                                    <option value="pz">pz</option>
                                    <option value="kg">kg</option>
                                    <option value="g">g</option>
                                    <option value="L">L</option>
                                    <option value="ml">ml</option>
                                    <option value="conf">conf</option>
                                    <option value="scat">scat</option>
                                    <option value="vas">vas</option>
                                    <option value="bott">bott</option>
                                    <option value="pacco">pacco</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="shoppingNotes" class="notes-area">
                        <div class="form-group">
                            <label class="form-label">Note (opzionale)</label>
                            <textarea id="shoppingNotesInput" class="input" placeholder="Es: biologico, scadenza 15/02..."></textarea>
                        </div>
                    </div>

                    <button class="btn-add" onclick="addItem('shopping')">+ Aggiungi</button>
                </div>

                <div id="shoppingList" class="items-list"></div>
            </div>

            <!-- Stats Section -->
            <div id="stats" class="section">
                <h2 class="stats-title">üìä Analisi Inventario</h2>
                <div id="statsContent"></div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 class="modal-title" id="modalTitle"></h3>
            <textarea id="modalTextarea" class="input" rows="4" placeholder="Aggiungi note..."></textarea>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeModal()">Annulla</button>
                <button class="modal-btn modal-btn-save" onclick="saveNotes()">Salva</button>
            </div>
        </div>
    </div>

    <!-- Install Button -->
    <button id="installBtn" class="install-btn">üì≤ Installa App</button>

    <script>
        // Unit√† e Database
        const UNITS = ['pz', 'kg', 'g', 'L', 'ml', 'conf', 'scat', 'vas', 'bott', 'pacco'];

        const FOOD_DATABASE = [
          { id: 1, nome: 'Mela', nomeAlternativo: ['mele'], categoria: 'Frutta', icona: 'üçé', unitaPredefinita: 'pz' },
          { id: 2, nome: 'Banana', nomeAlternativo: ['banane'], categoria: 'Frutta', icona: 'üçå', unitaPredefinita: 'pz' },
          { id: 3, nome: 'Arancia', nomeAlternativo: ['arance'], categoria: 'Frutta', icona: 'üçä', unitaPredefinita: 'pz' },
          { id: 4, nome: 'Pera', nomeAlternativo: ['pere'], categoria: 'Frutta', icona: 'üçê', unitaPredefinita: 'pz' },
          { id: 5, nome: 'Fragola', nomeAlternativo: ['fragole'], categoria: 'Frutta', icona: 'üçì', unitaPredefinita: 'g' },
          { id: 6, nome: 'Uva', nomeAlternativo: [], categoria: 'Frutta', icona: 'üçá', unitaPredefinita: 'kg' },
          { id: 7, nome: 'Kiwi', nomeAlternativo: [], categoria: 'Frutta', icona: 'ü•ù', unitaPredefinita: 'pz' },
          { id: 8, nome: 'Limone', nomeAlternativo: ['limoni'], categoria: 'Frutta', icona: 'üçã', unitaPredefinita: 'pz' },
          { id: 9, nome: 'Anguria', nomeAlternativo: ['cocomero'], categoria: 'Frutta', icona: 'üçâ', unitaPredefinita: 'kg' },
          { id: 10, nome: 'Pesca', nomeAlternativo: ['pesche'], categoria: 'Frutta', icona: 'üçë', unitaPredefinita: 'pz' },
          { id: 11, nome: 'Pomodoro', nomeAlternativo: ['pomodori'], categoria: 'Verdura', icona: 'üçÖ', unitaPredefinita: 'kg' },
          { id: 12, nome: 'Patata', nomeAlternativo: ['patate'], categoria: 'Verdura', icona: 'ü•î', unitaPredefinita: 'kg' },
          { id: 13, nome: 'Carota', nomeAlternativo: ['carote'], categoria: 'Verdura', icona: 'ü•ï', unitaPredefinita: 'kg' },
          { id: 14, nome: 'Cipolla', nomeAlternativo: ['cipolle'], categoria: 'Verdura', icona: 'üßÖ', unitaPredefinita: 'kg' },
          { id: 15, nome: 'Zucchina', nomeAlternativo: ['zucchine'], categoria: 'Verdura', icona: 'ü•í', unitaPredefinita: 'kg' },
          { id: 16, nome: 'Melanzana', nomeAlternativo: ['melanzane'], categoria: 'Verdura', icona: 'üçÜ', unitaPredefinita: 'kg' },
          { id: 17, nome: 'Peperone', nomeAlternativo: ['peperoni'], categoria: 'Verdura', icona: 'ü´ë', unitaPredefinita: 'pz' },
          { id: 18, nome: 'Insalata', nomeAlternativo: ['lattuga'], categoria: 'Verdura', icona: 'ü•¨', unitaPredefinita: 'pz' },
          { id: 19, nome: 'Broccoli', nomeAlternativo: [], categoria: 'Verdura', icona: 'ü•¶', unitaPredefinita: 'kg' },
          { id: 20, nome: 'Spinaci', nomeAlternativo: [], categoria: 'Verdura', icona: 'üåø', unitaPredefinita: 'g' },
          { id: 21, nome: 'Ceci', nomeAlternativo: [], categoria: 'Legumi', icona: 'ü´ò', unitaPredefinita: 'scat' },
          { id: 22, nome: 'Lenticchie', nomeAlternativo: [], categoria: 'Legumi', icona: 'ü´ò', unitaPredefinita: 'g' },
          { id: 23, nome: 'Fagioli', nomeAlternativo: [], categoria: 'Legumi', icona: 'ü´ò', unitaPredefinita: 'scat' },
          { id: 24, nome: 'Piselli', nomeAlternativo: [], categoria: 'Legumi', icona: 'ü´õ', unitaPredefinita: 'scat' },
          { id: 25, nome: 'Fave', nomeAlternativo: [], categoria: 'Legumi', icona: 'ü´ò', unitaPredefinita: 'g' },
          { id: 26, nome: 'Latte', nomeAlternativo: [], categoria: 'Latticini', icona: 'ü•õ', unitaPredefinita: 'L' },
          { id: 27, nome: 'Yogurt', nomeAlternativo: [], categoria: 'Latticini', icona: 'ü•õ', unitaPredefinita: 'vas' },
          { id: 28, nome: 'Formaggio', nomeAlternativo: ['formaggi'], categoria: 'Latticini', icona: 'üßÄ', unitaPredefinita: 'g' },
          { id: 29, nome: 'Mozzarella', nomeAlternativo: [], categoria: 'Latticini', icona: 'üßÄ', unitaPredefinita: 'pz' },
          { id: 30, nome: 'Parmigiano', nomeAlternativo: ['grana'], categoria: 'Latticini', icona: 'üßÄ', unitaPredefinita: 'g' },
          { id: 31, nome: 'Burro', nomeAlternativo: [], categoria: 'Latticini', icona: 'üßà', unitaPredefinita: 'g' },
          { id: 32, nome: 'Pollo', nomeAlternativo: [], categoria: 'Carne', icona: 'üçó', unitaPredefinita: 'kg' },
          { id: 33, nome: 'Manzo', nomeAlternativo: [], categoria: 'Carne', icona: 'ü•©', unitaPredefinita: 'kg' },
          { id: 34, nome: 'Maiale', nomeAlternativo: [], categoria: 'Carne', icona: 'ü•ì', unitaPredefinita: 'kg' },
          { id: 35, nome: 'Tacchino', nomeAlternativo: [], categoria: 'Carne', icona: 'ü¶É', unitaPredefinita: 'kg' },
          { id: 36, nome: 'Salsiccia', nomeAlternativo: ['salsicce'], categoria: 'Carne', icona: 'üå≠', unitaPredefinita: 'kg' },
          { id: 37, nome: 'Salmone', nomeAlternativo: [], categoria: 'Pesce', icona: 'üêü', unitaPredefinita: 'kg' },
          { id: 38, nome: 'Tonno', nomeAlternativo: [], categoria: 'Pesce', icona: 'üêü', unitaPredefinita: 'scat' },
          { id: 39, nome: 'Merluzzo', nomeAlternativo: [], categoria: 'Pesce', icona: 'üêü', unitaPredefinita: 'kg' },
          { id: 40, nome: 'Gamberi', nomeAlternativo: [], categoria: 'Pesce', icona: 'ü¶ê', unitaPredefinita: 'g' },
          { id: 41, nome: 'Cozze', nomeAlternativo: [], categoria: 'Pesce', icona: 'ü¶™', unitaPredefinita: 'kg' },
          { id: 42, nome: 'Pasta', nomeAlternativo: [], categoria: 'Cereali', icona: 'üçù', unitaPredefinita: 'pacco' },
          { id: 43, nome: 'Riso', nomeAlternativo: [], categoria: 'Cereali', icona: 'üçö', unitaPredefinita: 'kg' },
          { id: 44, nome: 'Pane', nomeAlternativo: [], categoria: 'Cereali', icona: 'üçû', unitaPredefinita: 'pz' },
          { id: 45, nome: 'Farina', nomeAlternativo: [], categoria: 'Cereali', icona: 'üåæ', unitaPredefinita: 'kg' },
          { id: 46, nome: 'Cereali', nomeAlternativo: [], categoria: 'Cereali', icona: 'ü•£', unitaPredefinita: 'scat' },
          { id: 47, nome: 'Biscotti', nomeAlternativo: [], categoria: 'Cereali', icona: 'üç™', unitaPredefinita: 'pacco' },
          { id: 48, nome: 'Olio', nomeAlternativo: [], categoria: 'Condimenti', icona: 'ü´í', unitaPredefinita: 'L' },
          { id: 49, nome: 'Sale', nomeAlternativo: [], categoria: 'Condimenti', icona: 'üßÇ', unitaPredefinita: 'kg' },
          { id: 50, nome: 'Pepe', nomeAlternativo: [], categoria: 'Condimenti', icona: 'üå∂Ô∏è', unitaPredefinita: 'g' },
          { id: 51, nome: 'Aceto', nomeAlternativo: [], categoria: 'Condimenti', icona: 'üç∂', unitaPredefinita: 'L' },
          { id: 52, nome: 'Zucchero', nomeAlternativo: [], categoria: 'Condimenti', icona: 'üçØ', unitaPredefinita: 'kg' },
          { id: 53, nome: 'Acqua', nomeAlternativo: [], categoria: 'Bevande', icona: 'üíß', unitaPredefinita: 'bott' },
          { id: 54, nome: 'Succo', nomeAlternativo: [], categoria: 'Bevande', icona: 'üßÉ', unitaPredefinita: 'L' },
          { id: 55, nome: 'Caff√®', nomeAlternativo: [], categoria: 'Bevande', icona: '‚òï', unitaPredefinita: 'g' },
          { id: 56, nome: 'T√®', nomeAlternativo: [], categoria: 'Bevande', icona: 'üçµ', unitaPredefinita: 'scat' },
          { id: 57, nome: 'Vino', nomeAlternativo: [], categoria: 'Bevande', icona: 'üç∑', unitaPredefinita: 'bott' },
          { id: 58, nome: 'Birra', nomeAlternativo: [], categoria: 'Bevande', icona: 'üç∫', unitaPredefinita: 'bott' },
        ];

        const CATEGORY_COLORS = {
          'Frutta': '#FF6B9D',
          'Verdura': '#4CAF50',
          'Legumi': '#8D6E63',
          'Latticini': '#64B5F6',
          'Carne': '#EF5350',
          'Pesce': '#26C6DA',
          'Cereali': '#FFA726',
          'Condimenti': '#9575CD',
          'Bevande': '#42A5F5',
          'Altro': '#78909C'
        };

        let inventory = [];
        let shopping = [];
        let selectedFood = { inventory: null, shopping: null };
        let editingItem = null;
        let currentTab = 'inventory';

        // Load data
        function loadData() {
            const savedInventory = localStorage.getItem('dispensa_inventory');
            const savedShopping = localStorage.getItem('dispensa_shopping');
            
            if (savedInventory) inventory = JSON.parse(savedInventory);
            if (savedShopping) shopping = JSON.parse(savedShopping);
            
            renderInventory();
            renderShopping();
        }

        // Save data
        function saveData() {
            localStorage.setItem('dispensa_inventory', JSON.stringify(inventory));
            localStorage.setItem('dispensa_shopping', JSON.stringify(shopping));
        }

        // Switch tab
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            event.target.closest('.tab').classList.add('active');
            document.getElementById(tab).classList.add('active');
            
            if (tab === 'stats') {
                renderStats();
            }
        }

        // Handle search
        function handleSearch(type) {
            const input = document.getElementById(type + 'Search');
            const suggestionsDiv = document.getElementById(type + 'Suggestions');
            const searchTerm = input.value.toLowerCase().trim();

            if (searchTerm.length < 2) {
                suggestionsDiv.classList.remove('show');
                selectedFood[type] = null;
                document.getElementById(type + 'Notes').classList.remove('show');
                return;
            }

            const matches = FOOD_DATABASE.filter(food => {
                const nameMatch = food.nome.toLowerCase().includes(searchTerm);
                const altMatch = food.nomeAlternativo.some(alt => alt.toLowerCase().includes(searchTerm));
                return nameMatch || altMatch;
            }).slice(0, 5);

            if (matches.length > 0) {
                suggestionsDiv.innerHTML = matches.map(food => `
                    <div class="suggestion-item" onclick="selectFood(${food.id}, '${type}')">
                        <span class="suggestion-icon">${food.icona}</span>
                        <div class="suggestion-text">
                            <div class="suggestion-name">${food.nome}</div>
                            <div class="suggestion-category">${food.categoria}</div>
                        </div>
                    </div>
                `).join('');
                suggestionsDiv.classList.add('show');
            } else {
                suggestionsDiv.classList.remove('show');
            }
        }

        function selectFood(id, type) {
            const food = FOOD_DATABASE.find(f => f.id === id);
            selectedFood[type] = food;
            
            document.getElementById(type + 'Search').value = food.nome;
            document.getElementById(type + 'Suggestions').classList.remove('show');
            document.getElementById(type + 'Notes').classList.add('show');
            
            if (food.unitaPredefinita) {
                document.getElementById(type + 'Unit').value = food.unitaPredefinita;
            }
        }

        function addItem(type) {
            const searchInput = document.getElementById(type + 'Search');
            const qtyInput = document.getElementById(type + 'Qty');
            const unitSelect = document.getElementById(type + 'Unit');
            const notesInput = document.getElementById(type + 'NotesInput');
            
            const searchTerm = searchInput.value.trim();
            if (!searchTerm) return;

            const newItem = {
                id: Date.now(),
                nome: selectedFood[type] ? selectedFood[type].nome : searchTerm,
                categoria: selectedFood[type] ? selectedFood[type].categoria : 'Altro',
                icona: selectedFood[type] ? selectedFood[type].icona : 'üì¶',
                quantita: qtyInput.value || '1',
                unita: unitSelect.value,
                note: notesInput.value,
                personalizzato: !selectedFood[type],
                checked: false
            };

            if (type === 'inventory') {
                inventory.push(newItem);
                renderInventory();
            } else {
                shopping.push(newItem);
                renderShopping();
            }

            saveData();

            // Reset
            searchInput.value = '';
            qtyInput.value = '';
            unitSelect.value = 'pz';
            notesInput.value = '';
            selectedFood[type] = null;
            document.getElementById(type + 'Notes').classList.remove('show');
            document.getElementById(type + 'Suggestions').classList.remove('show');
        }

        function renderInventory() {
            const list = document.getElementById('inventoryList');
            const count = document.getElementById('inventoryCount');
            
            count.textContent = inventory.length;

            if (inventory.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üè†</div>
                        <div class="empty-text">Nessun prodotto</div>
                        <div class="empty-subtext">Inizia ad aggiungere i tuoi alimenti!</div>
                    </div>
                `;
                return;
            }

            list.innerHTML = inventory.map(item => `
                <div class="item">
                    <div class="item-header">
                        <span class="item-icon">${item.icona}</span>
                        <div class="item-info">
                            <div class="item-name">${item.nome}</div>
                            <div class="item-meta">
                                <span class="category-badge" style="background: ${CATEGORY_COLORS[item.categoria]}">${item.categoria}</span>
                                <span class="item-quantity">${item.quantita} ${item.unita || ''}</span>
                            </div>
                            ${item.note ? `<div class="item-notes">üìå ${item.note}</div>` : ''}
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="btn-action btn-note" onclick="editNotes(${item.id}, 'inventory')">üìù</button>
                        <button class="btn-action btn-move" onclick="moveToShopping(${item.id})">‚Üí Spesa</button>
                        <button class="btn-action btn-delete" onclick="deleteItem(${item.id}, 'inventory')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function renderShopping() {
            const list = document.getElementById('shoppingList');
            const count = document.getElementById('shoppingCount');
            
            count.textContent = shopping.length;

            if (shopping.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìù</div>
                        <div class="empty-text">Lista vuota</div>
                        <div class="empty-subtext">Aggiungi prodotti da comprare!</div>
                    </div>
                `;
                return;
            }

            list.innerHTML = shopping.map(item => `
                <div class="item ${item.checked ? 'checked' : ''}">
                    <div class="item-header">
                        <span class="item-icon">${item.icona}</span>
                        <div class="item-info">
                            <div class="item-name">${item.nome}</div>
                            <div class="item-meta">
                                <span class="category-badge" style="background: ${CATEGORY_COLORS[item.categoria]}">${item.categoria}</span>
                                <span class="item-quantity">${item.quantita} ${item.unita || ''}</span>
                            </div>
                            ${item.note ? `<div class="item-notes">üìå ${item.note}</div>` : ''}
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="btn-action btn-check" onclick="toggleCheck(${item.id})">${item.checked ? '‚úì' : '‚óã'}</button>
                        <button class="btn-action btn-note" onclick="editNotes(${item.id}, 'shopping')">üìù</button>
                        <button class="btn-action btn-move" onclick="moveToInventory(${item.id})">‚Üí Casa</button>
                        <button class="btn-action btn-delete" onclick="deleteItem(${item.id}, 'shopping')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function renderStats() {
            const container = document.getElementById('statsContent');
            
            if (inventory.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìä</div>
                        <div class="empty-text">Nessun dato</div>
                        <div class="empty-subtext">Aggiungi prodotti all'inventario</div>
                    </div>
                `;
                return;
            }

            const categoryCounts = {};
            inventory.forEach(item => {
                const category = item.categoria || 'Altro';
                categoryCounts[category] = (categoryCounts[category] || 0) + 1;
            });

            const total = inventory.length;
            const chartData = Object.entries(categoryCounts)
                .map(([name, value]) => ({
                    name,
                    value,
                    percentage: ((value / total) * 100).toFixed(1)
                }))
                .sort((a, b) => b.value - a.value);

            container.innerHTML = `
                <div class="stats-overview">
                    <div class="stats-card">
                        <div class="stats-card-number">${total}</div>
                        <div class="stats-card-label">Prodotti</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-card-number">${Object.keys(categoryCounts).length}</div>
                        <div class="stats-card-label">Categorie</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">Distribuzione per Categoria</h3>
                    <canvas id="pieChart" width="280" height="280"></canvas>
                </div>

                <div class="category-list">
                    <h3 class="category-list-title">Dettaglio</h3>
                    ${chartData.map(cat => `
                        <div class="category-item">
                            <div class="category-item-left">
                                <div class="category-dot" style="background: ${CATEGORY_COLORS[cat.name]}"></div>
                                <span class="category-item-name">${cat.name}</span>
                            </div>
                            <div class="category-item-right">
                                <span class="category-item-count">${cat.value}</span>
                                <span class="category-item-percent">${cat.percentage}%</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            drawPieChart(chartData);
        }

        function drawPieChart(data) {
            const canvas = document.getElementById('pieChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 90;
            
            let currentAngle = -Math.PI / 2;
            
            data.forEach(segment => {
                const sliceAngle = (segment.value / inventory.length) * 2 * Math.PI;
                
                ctx.fillStyle = CATEGORY_COLORS[segment.name];
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.fill();
                
                const labelAngle = currentAngle + sliceAngle / 2;
                const labelX = centerX + Math.cos(labelAngle) * (radius + 25);
                const labelY = centerY + Math.sin(labelAngle) * (radius + 25);
                
                ctx.fillStyle = '#111827';
                ctx.font = 'bold 11px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(segment.percentage + '%', labelX, labelY);
                
                currentAngle += sliceAngle;
            });
        }

        function deleteItem(id, type) {
            if (type === 'inventory') {
                inventory = inventory.filter(item => item.id !== id);
                renderInventory();
            } else {
                shopping = shopping.filter(item => item.id !== id);
                renderShopping();
            }
            saveData();
            if (currentTab === 'stats') renderStats();
        }

        function moveToShopping(id) {
            const item = inventory.find(i => i.id === id);
            if (item) {
                shopping.push({ ...item, id: Date.now(), checked: false });
                inventory = inventory.filter(i => i.id !== id);
                renderInventory();
                renderShopping();
                saveData();
                if (currentTab === 'stats') renderStats();
            }
        }

        function moveToInventory(id) {
            const item = shopping.find(i => i.id === id);
            if (item) {
                inventory.push({ ...item, id: Date.now(), checked: false });
                shopping = shopping.filter(i => i.id !== id);
                renderInventory();
                renderShopping();
                saveData();
                if (currentTab === 'stats') renderStats();
            }
        }

        function toggleCheck(id) {
            const item = shopping.find(i => i.id === id);
            if (item) {
                item.checked = !item.checked;
                renderShopping();
                saveData();
            }
        }

        function editNotes(id, type) {
            const item = (type === 'inventory' ? inventory : shopping).find(i => i.id === id);
            if (item) {
                editingItem = { item, type };
                document.getElementById('modalTitle').textContent = `${item.icona} ${item.nome}`;
                document.getElementById('modalTextarea').value = item.note || '';
                document.getElementById('modal').classList.add('show');
            }
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('show');
            editingItem = null;
        }

        function saveNotes() {
            if (!editingItem) return;
            
            const notes = document.getElementById('modalTextarea').value;
            editingItem.item.note = notes;
            
            if (editingItem.type === 'inventory') {
                renderInventory();
            } else {
                renderShopping();
            }
            
            saveData();
            closeModal();
        }

        // Click outside to close
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.autocomplete')) {
                document.querySelectorAll('.suggestions').forEach(s => s.classList.remove('show'));
            }
        });

        // Load on start
        loadData();
    </script>

    <!-- Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(reg => console.log('SW registered'))
                    .catch(err => console.log('SW error:', err));
            });
        }

        // Install prompt
        let deferredPrompt;
        const installBtn = document.getElementById('installBtn');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'block';
        });

        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                installBtn.style.display = 'none';
            }
        });

        window.addEventListener('appinstalled', () => {
            installBtn.style.display = 'none';
        });
    </script>
</body>
</html>
